
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Service objects designed with OOP in mind.">
      
      
      
        <link rel="canonical" href="https://proofit404.github.io/stories/state/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.0, mkdocs-material-8.5.6">
    
    
      
        <title>State - stories</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.20d9efc8.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.cbb835fc.min.css">
        
          
          
          <meta name="theme-color" content="#7e56c2">
        
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="deep-purple" data-md-color-accent="deep-purple">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#state" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="stories" class="md-header__button md-logo" aria-label="stories" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19.14 7.5A2.86 2.86 0 0 1 22 10.36v3.78A2.86 2.86 0 0 1 19.14 17H12c0 .39.32.96.71.96H17v1.68a2.86 2.86 0 0 1-2.86 2.86H9.86A2.86 2.86 0 0 1 7 19.64v-3.75a2.85 2.85 0 0 1 2.86-2.85h5.25a2.85 2.85 0 0 0 2.85-2.86V7.5h1.18m-4.28 11.79c-.4 0-.72.3-.72.89 0 .59.32.71.72.71a.71.71 0 0 0 .71-.71c0-.59-.32-.89-.71-.89m-10-1.79A2.86 2.86 0 0 1 2 14.64v-3.78A2.86 2.86 0 0 1 4.86 8H12c0-.39-.32-.96-.71-.96H7V5.36A2.86 2.86 0 0 1 9.86 2.5h4.28A2.86 2.86 0 0 1 17 5.36v3.75a2.85 2.85 0 0 1-2.86 2.85H8.89a2.85 2.85 0 0 0-2.85 2.86v2.68H4.86M9.14 5.71c.4 0 .72-.3.72-.89 0-.59-.32-.71-.72-.71-.39 0-.71.12-.71.71s.32.89.71.89Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            stories
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              State
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/proofit404/stories" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    proofit404/stories
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href=".." class="md-tabs__link">
        Home
      </a>
    </li>
  

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../story/" class="md-tabs__link md-tabs__link--active">
        Usage
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../transactions/" class="md-tabs__link">
        Guides
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="stories" class="md-nav__button md-logo" aria-label="stories" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19.14 7.5A2.86 2.86 0 0 1 22 10.36v3.78A2.86 2.86 0 0 1 19.14 17H12c0 .39.32.96.71.96H17v1.68a2.86 2.86 0 0 1-2.86 2.86H9.86A2.86 2.86 0 0 1 7 19.64v-3.75a2.85 2.85 0 0 1 2.86-2.85h5.25a2.85 2.85 0 0 0 2.85-2.86V7.5h1.18m-4.28 11.79c-.4 0-.72.3-.72.89 0 .59.32.71.72.71a.71.71 0 0 0 .71-.71c0-.59-.32-.89-.71-.89m-10-1.79A2.86 2.86 0 0 1 2 14.64v-3.78A2.86 2.86 0 0 1 4.86 8H12c0-.39-.32-.96-.71-.96H7V5.36A2.86 2.86 0 0 1 9.86 2.5h4.28A2.86 2.86 0 0 1 17 5.36v3.75a2.85 2.85 0 0 1-2.86 2.85H8.89a2.85 2.85 0 0 0-2.85 2.86v2.68H4.86M9.14 5.71c.4 0 .72-.3.72-.89 0-.59-.32-.71-.72-.71-.39 0-.71.12-.71.71s.32.89.71.89Z"/></svg>

    </a>
    stories
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/proofit404/stories" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    proofit404/stories
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_1" type="checkbox" id="__nav_1" >
      
      
      
      
        <label class="md-nav__link" for="__nav_1">
          Home
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Home" data-md-level="1">
        <label class="md-nav__title" for="__nav_1">
          <span class="md-nav__icon md-icon"></span>
          Home
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../installation/" class="md-nav__link">
        Installation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../changelog/" class="md-nav__link">
        Changelog
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_2">
          Usage
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Usage" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Usage
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../story/" class="md-nav__link">
        Story
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          State
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        State
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#principles" class="md-nav__link">
    Principles
  </a>
  
    <nav class="md-nav" aria-label="Principles">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#variable-allow-attribute-assignment" class="md-nav__link">
    Variable allow attribute assignment
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#argument-allow-constructor-usage" class="md-nav__link">
    Argument allow constructor usage
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#only-declared-variables-could-be-assigned" class="md-nav__link">
    Only declared variables could be assigned
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#only-declared-arguments-could-be-passed" class="md-nav__link">
    Only declared arguments could be passed
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#attribute-assignment-validates-variable-value" class="md-nav__link">
    Attribute assignment validates variable value
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#constructor-argument-validates-passed-value" class="md-nav__link">
    Constructor argument validates passed value
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#validation-errors-are-propagated-as-usual-errors" class="md-nav__link">
    Validation errors are propagated as usual errors
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#validation-errors-would-be-raised-by-constructor" class="md-nav__link">
    Validation errors would be raised by constructor
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#validation-could-normalize-value" class="md-nav__link">
    Validation could normalize value
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#state-union-joins-all-defined-variables" class="md-nav__link">
    State union joins all defined variables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#state-union-joins-all-variable-validators" class="md-nav__link">
    State union joins all variable validators
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../actor/" class="md-nav__link">
        Actor
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../initiate/" class="md-nav__link">
        Initiate
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Guides
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Guides" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Guides
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../transactions/" class="md-nav__link">
        Transactions
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#principles" class="md-nav__link">
    Principles
  </a>
  
    <nav class="md-nav" aria-label="Principles">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#variable-allow-attribute-assignment" class="md-nav__link">
    Variable allow attribute assignment
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#argument-allow-constructor-usage" class="md-nav__link">
    Argument allow constructor usage
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#only-declared-variables-could-be-assigned" class="md-nav__link">
    Only declared variables could be assigned
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#only-declared-arguments-could-be-passed" class="md-nav__link">
    Only declared arguments could be passed
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#attribute-assignment-validates-variable-value" class="md-nav__link">
    Attribute assignment validates variable value
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#constructor-argument-validates-passed-value" class="md-nav__link">
    Constructor argument validates passed value
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#validation-errors-are-propagated-as-usual-errors" class="md-nav__link">
    Validation errors are propagated as usual errors
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#validation-errors-would-be-raised-by-constructor" class="md-nav__link">
    Validation errors would be raised by constructor
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#validation-could-normalize-value" class="md-nav__link">
    Validation could normalize value
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#state-union-joins-all-defined-variables" class="md-nav__link">
    State union joins all defined variables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#state-union-joins-all-variable-validators" class="md-nav__link">
    State union joins all variable validators
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="state">State<a class="headerlink" href="#state" title="Permanent link">&para;</a></h1>
<p>It's hard to figure out what variables could be set by story. Or what arguments
it does expect as input. It is possible to make this state contract explicit.
You could inherit from <code>State</code> class and define allowed variables and arguments
on it.</p>
<h2 id="principles">Principles<a class="headerlink" href="#principles" title="Permanent link">&para;</a></h2>
<ul>
<li><a href="#variable-allow-attribute-assignment">Variable allow attribute assignment</a></li>
<li><a href="#argument-allow-constructor-usage">Argument allow constructor usage</a></li>
<li><a href="#only-declared-variables-could-be-assigned">Only declared variables could be assigned</a></li>
<li><a href="#only-declared-arguments-could-be-passed">Only declared arguments could be passed</a></li>
<li><a href="#attribute-assignment-validates-variable-value">Attribute assignment validates variable value</a></li>
<li><a href="#constructor-argument-validates-passed-value">Constructor argument validates passed value</a></li>
<li><a href="#validation-errors-are-propagated-as-usual-errors">Validation errors are propagated as usual errors</a></li>
<li><a href="#validation-errors-would-be-raised-by-constructor">Validation errors would be raised by constructor</a></li>
<li><a href="#validation-could-normalize-value">Validation could normalize value</a></li>
<li><a href="#state-union-joins-all-defined-variables">State union joins all defined variables</a></li>
<li><a href="#state-union-joins-all-variable-validators">State union joins all variable validators</a></li>
</ul>
<h3 id="variable-allow-attribute-assignment">Variable allow attribute assignment<a class="headerlink" href="#variable-allow-attribute-assignment" title="Permanent link">&para;</a></h3>
<p>Classes inherited from <code>State</code> could reduce set of variables which allowed to be
defined by attribute assignment. If you declare variable on the state class, it
could be assignment once inside step method.</p>
<div class="tabbed-set" data-tabs="1:2"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><label for="__tabbed_1_1">sync</label><div class="tabbed-content">
<div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">stories</span> <span class="kn">import</span> <span class="n">Story</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">State</span><span class="p">,</span> <span class="n">Variable</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">app.repositories</span> <span class="kn">import</span> <span class="n">load_order</span><span class="p">,</span> <span class="n">load_customer</span><span class="p">,</span> <span class="n">create_payment</span>

<span class="gp">&gt;&gt;&gt; </span><span class="nd">@dataclass</span>
<span class="gp">... </span><span class="k">class</span> <span class="nc">Purchase</span><span class="p">(</span><span class="n">Story</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">I</span><span class="o">.</span><span class="n">find_order</span>
<span class="gp">... </span>    <span class="n">I</span><span class="o">.</span><span class="n">find_customer</span>
<span class="gp">... </span>    <span class="n">I</span><span class="o">.</span><span class="n">check_balance</span>
<span class="gp">... </span>    <span class="n">I</span><span class="o">.</span><span class="n">persist_payment</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">find_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="gp">... </span>        <span class="n">state</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_order</span><span class="p">(</span><span class="n">order_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">find_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="gp">... </span>        <span class="n">state</span><span class="o">.</span><span class="n">customer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_customer</span><span class="p">(</span><span class="n">customer_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">check_balance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="gp">... </span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span><span class="o">.</span><span class="n">order</span><span class="o">.</span><span class="n">affordable_for</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">customer</span><span class="p">):</span>
<span class="gp">... </span>            <span class="k">raise</span> <span class="ne">Exception</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">persist_payment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="gp">... </span>        <span class="n">state</span><span class="o">.</span><span class="n">payment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_payment</span><span class="p">(</span><span class="n">order_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">customer_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="n">load_order</span><span class="p">:</span> <span class="n">Callable</span>
<span class="gp">... </span>    <span class="n">load_customer</span><span class="p">:</span> <span class="n">Callable</span>
<span class="gp">... </span>    <span class="n">create_payment</span><span class="p">:</span> <span class="n">Callable</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">PurchaseState</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">order</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">()</span>
<span class="gp">... </span>    <span class="n">customer</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">()</span>
<span class="gp">... </span>    <span class="n">payment</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">purchase</span> <span class="o">=</span> <span class="n">Purchase</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">load_order</span><span class="o">=</span><span class="n">load_order</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">load_customer</span><span class="o">=</span><span class="n">load_customer</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">create_payment</span><span class="o">=</span><span class="n">create_payment</span><span class="p">,</span>
<span class="gp">... </span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">state</span> <span class="o">=</span> <span class="n">PurchaseState</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">purchase</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">state</span><span class="o">.</span><span class="n">payment</span>
<span class="go">Payment(due_date=datetime.datetime(1999, 12, 31, 0, 0))</span>
</code></pre></div>
</div>
<input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><label for="__tabbed_1_2">async</label><div class="tabbed-content">
<div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Coroutine</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">stories</span> <span class="kn">import</span> <span class="n">Story</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">State</span><span class="p">,</span> <span class="n">Variable</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">aioapp.repositories</span> <span class="kn">import</span> <span class="n">load_order</span><span class="p">,</span> <span class="n">load_customer</span><span class="p">,</span> <span class="n">create_payment</span>

<span class="gp">&gt;&gt;&gt; </span><span class="nd">@dataclass</span>
<span class="gp">... </span><span class="k">class</span> <span class="nc">Purchase</span><span class="p">(</span><span class="n">Story</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">I</span><span class="o">.</span><span class="n">find_order</span>
<span class="gp">... </span>    <span class="n">I</span><span class="o">.</span><span class="n">find_customer</span>
<span class="gp">... </span>    <span class="n">I</span><span class="o">.</span><span class="n">check_balance</span>
<span class="gp">... </span>    <span class="n">I</span><span class="o">.</span><span class="n">persist_payment</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">find_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="gp">... </span>        <span class="n">state</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_order</span><span class="p">(</span><span class="n">order_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">find_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="gp">... </span>        <span class="n">state</span><span class="o">.</span><span class="n">customer</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_customer</span><span class="p">(</span><span class="n">customer_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">check_balance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="gp">... </span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span><span class="o">.</span><span class="n">order</span><span class="o">.</span><span class="n">affordable_for</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">customer</span><span class="p">):</span>
<span class="gp">... </span>            <span class="k">raise</span> <span class="ne">Exception</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">persist_payment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="gp">... </span>        <span class="n">state</span><span class="o">.</span><span class="n">payment</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_payment</span><span class="p">(</span>
<span class="gp">... </span>            <span class="n">order_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">customer_id</span><span class="o">=</span><span class="mi">1</span>
<span class="gp">... </span>        <span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="n">load_order</span><span class="p">:</span> <span class="n">Coroutine</span>
<span class="gp">... </span>    <span class="n">load_customer</span><span class="p">:</span> <span class="n">Coroutine</span>
<span class="gp">... </span>    <span class="n">create_payment</span><span class="p">:</span> <span class="n">Coroutine</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">PurchaseState</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">order</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">()</span>
<span class="gp">... </span>    <span class="n">customer</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">()</span>
<span class="gp">... </span>    <span class="n">payment</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">purchase</span> <span class="o">=</span> <span class="n">Purchase</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">load_order</span><span class="o">=</span><span class="n">load_order</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">load_customer</span><span class="o">=</span><span class="n">load_customer</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">create_payment</span><span class="o">=</span><span class="n">create_payment</span><span class="p">,</span>
<span class="gp">... </span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">state</span> <span class="o">=</span> <span class="n">PurchaseState</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">purchase</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">state</span><span class="o">.</span><span class="n">payment</span>
<span class="go">Payment(due_date=datetime.datetime(1999, 12, 31, 0, 0))</span>
</code></pre></div>
</div>
</div>
<h3 id="argument-allow-constructor-usage">Argument allow constructor usage<a class="headerlink" href="#argument-allow-constructor-usage" title="Permanent link">&para;</a></h3>
<p>Argument declaration is superset of the Variable declaration. All rules applied
to Variable applies to Argument as well. For example, variable declared as
Argument is allowed to be assigned as attribute by one of the story step.</p>
<p>However, Argument declaration allows variable with that name to be passed to the
state constructor before story execution would even starts.</p>
<div class="tabbed-set" data-tabs="2:2"><input checked="checked" id="__tabbed_2_1" name="__tabbed_2" type="radio" /><label for="__tabbed_2_1">sync</label><div class="tabbed-content">
<div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">stories</span> <span class="kn">import</span> <span class="n">Story</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">State</span><span class="p">,</span> <span class="n">Argument</span><span class="p">,</span> <span class="n">Variable</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">app.repositories</span> <span class="kn">import</span> <span class="n">load_order</span><span class="p">,</span> <span class="n">load_customer</span><span class="p">,</span> <span class="n">create_payment</span>

<span class="gp">&gt;&gt;&gt; </span><span class="nd">@dataclass</span>
<span class="gp">... </span><span class="k">class</span> <span class="nc">Purchase</span><span class="p">(</span><span class="n">Story</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">I</span><span class="o">.</span><span class="n">find_order</span>
<span class="gp">... </span>    <span class="n">I</span><span class="o">.</span><span class="n">find_customer</span>
<span class="gp">... </span>    <span class="n">I</span><span class="o">.</span><span class="n">check_balance</span>
<span class="gp">... </span>    <span class="n">I</span><span class="o">.</span><span class="n">persist_payment</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">find_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="gp">... </span>        <span class="n">state</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_order</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">order_id</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">find_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="gp">... </span>        <span class="n">state</span><span class="o">.</span><span class="n">customer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_customer</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">customer_id</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">check_balance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="gp">... </span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span><span class="o">.</span><span class="n">order</span><span class="o">.</span><span class="n">affordable_for</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">customer</span><span class="p">):</span>
<span class="gp">... </span>            <span class="k">raise</span> <span class="ne">Exception</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">persist_payment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="gp">... </span>        <span class="n">state</span><span class="o">.</span><span class="n">payment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_payment</span><span class="p">(</span>
<span class="gp">... </span>            <span class="n">order_id</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">order_id</span><span class="p">,</span> <span class="n">customer_id</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">customer_id</span>
<span class="gp">... </span>        <span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="n">load_order</span><span class="p">:</span> <span class="n">Callable</span>
<span class="gp">... </span>    <span class="n">load_customer</span><span class="p">:</span> <span class="n">Callable</span>
<span class="gp">... </span>    <span class="n">create_payment</span><span class="p">:</span> <span class="n">Callable</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">PurchaseState</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">order_id</span> <span class="o">=</span> <span class="n">Argument</span><span class="p">()</span>
<span class="gp">... </span>    <span class="n">customer_id</span> <span class="o">=</span> <span class="n">Argument</span><span class="p">()</span>
<span class="gp">... </span>    <span class="n">order</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">()</span>
<span class="gp">... </span>    <span class="n">customer</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">()</span>
<span class="gp">... </span>    <span class="n">payment</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">purchase</span> <span class="o">=</span> <span class="n">Purchase</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">load_order</span><span class="o">=</span><span class="n">load_order</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">load_customer</span><span class="o">=</span><span class="n">load_customer</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">create_payment</span><span class="o">=</span><span class="n">create_payment</span><span class="p">,</span>
<span class="gp">... </span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">state</span> <span class="o">=</span> <span class="n">PurchaseState</span><span class="p">(</span><span class="n">order_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">customer_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">purchase</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">state</span><span class="o">.</span><span class="n">payment</span>
<span class="go">Payment(due_date=datetime.datetime(1999, 12, 31, 0, 0))</span>
</code></pre></div>
</div>
<input id="__tabbed_2_2" name="__tabbed_2" type="radio" /><label for="__tabbed_2_2">async</label><div class="tabbed-content">
<div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Coroutine</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">stories</span> <span class="kn">import</span> <span class="n">Story</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">State</span><span class="p">,</span> <span class="n">Argument</span><span class="p">,</span> <span class="n">Variable</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">aioapp.repositories</span> <span class="kn">import</span> <span class="n">load_order</span><span class="p">,</span> <span class="n">load_customer</span><span class="p">,</span> <span class="n">create_payment</span>

<span class="gp">&gt;&gt;&gt; </span><span class="nd">@dataclass</span>
<span class="gp">... </span><span class="k">class</span> <span class="nc">Purchase</span><span class="p">(</span><span class="n">Story</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">I</span><span class="o">.</span><span class="n">find_order</span>
<span class="gp">... </span>    <span class="n">I</span><span class="o">.</span><span class="n">find_customer</span>
<span class="gp">... </span>    <span class="n">I</span><span class="o">.</span><span class="n">check_balance</span>
<span class="gp">... </span>    <span class="n">I</span><span class="o">.</span><span class="n">persist_payment</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">find_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="gp">... </span>        <span class="n">state</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_order</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">order_id</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">find_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="gp">... </span>        <span class="n">state</span><span class="o">.</span><span class="n">customer</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_customer</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">customer_id</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">check_balance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="gp">... </span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">state</span><span class="o">.</span><span class="n">order</span><span class="o">.</span><span class="n">affordable_for</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">customer</span><span class="p">):</span>
<span class="gp">... </span>            <span class="k">raise</span> <span class="ne">Exception</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">persist_payment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="gp">... </span>        <span class="n">state</span><span class="o">.</span><span class="n">payment</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_payment</span><span class="p">(</span>
<span class="gp">... </span>            <span class="n">order_id</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">order_id</span><span class="p">,</span> <span class="n">customer_id</span><span class="o">=</span><span class="n">state</span><span class="o">.</span><span class="n">customer_id</span>
<span class="gp">... </span>        <span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="n">load_order</span><span class="p">:</span> <span class="n">Coroutine</span>
<span class="gp">... </span>    <span class="n">load_customer</span><span class="p">:</span> <span class="n">Coroutine</span>
<span class="gp">... </span>    <span class="n">create_payment</span><span class="p">:</span> <span class="n">Coroutine</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">PurchaseState</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">order_id</span> <span class="o">=</span> <span class="n">Argument</span><span class="p">()</span>
<span class="gp">... </span>    <span class="n">customer_id</span> <span class="o">=</span> <span class="n">Argument</span><span class="p">()</span>
<span class="gp">... </span>    <span class="n">order</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">()</span>
<span class="gp">... </span>    <span class="n">customer</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">()</span>
<span class="gp">... </span>    <span class="n">payment</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">purchase</span> <span class="o">=</span> <span class="n">Purchase</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">load_order</span><span class="o">=</span><span class="n">load_order</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">load_customer</span><span class="o">=</span><span class="n">load_customer</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">create_payment</span><span class="o">=</span><span class="n">create_payment</span><span class="p">,</span>
<span class="gp">... </span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">state</span> <span class="o">=</span> <span class="n">PurchaseState</span><span class="p">(</span><span class="n">order_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">customer_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">purchase</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">state</span><span class="o">.</span><span class="n">payment</span>
<span class="go">Payment(due_date=datetime.datetime(1999, 12, 31, 0, 0))</span>
</code></pre></div>
</div>
</div>
<h3 id="only-declared-variables-could-be-assigned">Only declared variables could be assigned<a class="headerlink" href="#only-declared-variables-could-be-assigned" title="Permanent link">&para;</a></h3>
<p>Variables with random names allowed to be assigned only if you would use plain
<code>State</code> object. If you declare variables using inheritance from <code>State</code> class,
only declared variables would be allowed to be assigned later by steps. If you
try to assing unknown variable, an error would be raised.</p>
<div class="tabbed-set" data-tabs="3:2"><input checked="checked" id="__tabbed_3_1" name="__tabbed_3" type="radio" /><label for="__tabbed_3_1">sync</label><div class="tabbed-content">
<div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">stories</span> <span class="kn">import</span> <span class="n">Story</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">State</span><span class="p">,</span> <span class="n">Variable</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">app.repositories</span> <span class="kn">import</span> <span class="n">load_order</span>

<span class="gp">&gt;&gt;&gt; </span><span class="nd">@dataclass</span>
<span class="gp">... </span><span class="k">class</span> <span class="nc">Purchase</span><span class="p">(</span><span class="n">Story</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">I</span><span class="o">.</span><span class="n">find_order</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">find_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="gp">... </span>        <span class="n">state</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_order</span><span class="p">(</span><span class="n">order_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="n">load_order</span><span class="p">:</span> <span class="n">Callable</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">PurchaseState</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">customer</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">purchase</span> <span class="o">=</span> <span class="n">Purchase</span><span class="p">(</span><span class="n">load_order</span><span class="o">=</span><span class="n">load_order</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">state</span> <span class="o">=</span> <span class="n">PurchaseState</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">purchase</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
  <span class="c">...</span>
<span class="gr">_stories.exceptions.StateError</span>: <span class="n">Unknown variable assignment: order</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="go">PurchaseState</span>
</code></pre></div>
</div>
<input id="__tabbed_3_2" name="__tabbed_3" type="radio" /><label for="__tabbed_3_2">async</label><div class="tabbed-content">
<div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Coroutine</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">stories</span> <span class="kn">import</span> <span class="n">Story</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">State</span><span class="p">,</span> <span class="n">Variable</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">aioapp.repositories</span> <span class="kn">import</span> <span class="n">load_order</span>

<span class="gp">&gt;&gt;&gt; </span><span class="nd">@dataclass</span>
<span class="gp">... </span><span class="k">class</span> <span class="nc">Purchase</span><span class="p">(</span><span class="n">Story</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">I</span><span class="o">.</span><span class="n">find_order</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">find_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="gp">... </span>        <span class="n">state</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_order</span><span class="p">(</span><span class="n">order_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="n">load_order</span><span class="p">:</span> <span class="n">Coroutine</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">PurchaseState</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">customer</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">purchase</span> <span class="o">=</span> <span class="n">Purchase</span><span class="p">(</span><span class="n">load_order</span><span class="o">=</span><span class="n">load_order</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">state</span> <span class="o">=</span> <span class="n">PurchaseState</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">purchase</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>
<span class="gt">Traceback (most recent call last):</span>
  <span class="c">...</span>
<span class="gr">_stories.exceptions.StateError</span>: <span class="n">Unknown variable assignment: order</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="go">PurchaseState</span>
</code></pre></div>
</div>
</div>
<h3 id="only-declared-arguments-could-be-passed">Only declared arguments could be passed<a class="headerlink" href="#only-declared-arguments-could-be-passed" title="Permanent link">&para;</a></h3>
<p>If you try to pass an argument to the state class which was not declared using
<code>Argument</code>, error would be thrown immediately. Even if you declare state
attribute using <code>Variable</code> it will not be allowed to be used as state
constructor argument.</p>
<div class="tabbed-set" data-tabs="4:2"><input checked="checked" id="__tabbed_4_1" name="__tabbed_4" type="radio" /><label for="__tabbed_4_1">sync</label><div class="tabbed-content">
<div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">stories</span> <span class="kn">import</span> <span class="n">Story</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">State</span><span class="p">,</span> <span class="n">Argument</span><span class="p">,</span> <span class="n">Variable</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">app.repositories</span> <span class="kn">import</span> <span class="n">load_order</span>

<span class="gp">&gt;&gt;&gt; </span><span class="nd">@dataclass</span>
<span class="gp">... </span><span class="k">class</span> <span class="nc">Purchase</span><span class="p">(</span><span class="n">Story</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">I</span><span class="o">.</span><span class="n">find_order</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">find_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="gp">... </span>        <span class="n">state</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_order</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">order_id</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="n">load_order</span><span class="p">:</span> <span class="n">Callable</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">PurchaseState</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">order_id</span> <span class="o">=</span> <span class="n">Argument</span><span class="p">()</span>
<span class="gp">... </span>    <span class="n">order</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">purchase</span> <span class="o">=</span> <span class="n">Purchase</span><span class="p">(</span><span class="n">load_order</span><span class="o">=</span><span class="n">load_order</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">PurchaseState</span><span class="p">(</span><span class="n">customer_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
  <span class="c">...</span>
<span class="gr">_stories.exceptions.StateError</span>: <span class="n">Unknown argument passed: customer_id</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="go">PurchaseState</span>
</code></pre></div>
</div>
<input id="__tabbed_4_2" name="__tabbed_4" type="radio" /><label for="__tabbed_4_2">async</label><div class="tabbed-content">
<div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Coroutine</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">stories</span> <span class="kn">import</span> <span class="n">Story</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">State</span><span class="p">,</span> <span class="n">Argument</span><span class="p">,</span> <span class="n">Variable</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">aioapp.repositories</span> <span class="kn">import</span> <span class="n">load_order</span>

<span class="gp">&gt;&gt;&gt; </span><span class="nd">@dataclass</span>
<span class="gp">... </span><span class="k">class</span> <span class="nc">Purchase</span><span class="p">(</span><span class="n">Story</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">I</span><span class="o">.</span><span class="n">find_order</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">find_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="gp">... </span>        <span class="n">state</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_order</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">order_id</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="n">load_order</span><span class="p">:</span> <span class="n">Coroutine</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">PurchaseState</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">order_id</span> <span class="o">=</span> <span class="n">Argument</span><span class="p">()</span>
<span class="gp">... </span>    <span class="n">order</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">purchase</span> <span class="o">=</span> <span class="n">Purchase</span><span class="p">(</span><span class="n">load_order</span><span class="o">=</span><span class="n">load_order</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">PurchaseState</span><span class="p">(</span><span class="n">customer_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
  <span class="c">...</span>
<span class="gr">_stories.exceptions.StateError</span>: <span class="n">Unknown argument passed: customer_id</span>
<span class="go">&lt;BLANKLINE&gt;</span>
<span class="go">PurchaseState</span>
</code></pre></div>
</div>
</div>
<h3 id="attribute-assignment-validates-variable-value">Attribute assignment validates variable value<a class="headerlink" href="#attribute-assignment-validates-variable-value" title="Permanent link">&para;</a></h3>
<p>When story step assign attributes to the state, validator passed to the
<code>Variable</code> would be applied to the value.</p>
<p>Validator is a function of single argument. It should return attribute value or
raise exception if value is wrong.</p>
<p>If validator returns a value, it will be assigned to the state attribute.</p>
<div class="tabbed-set" data-tabs="5:2"><input checked="checked" id="__tabbed_5_1" name="__tabbed_5" type="radio" /><label for="__tabbed_5_1">sync</label><div class="tabbed-content">
<div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">stories</span> <span class="kn">import</span> <span class="n">Story</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">State</span><span class="p">,</span> <span class="n">Variable</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">app.repositories</span> <span class="kn">import</span> <span class="n">load_order</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">app.entities</span> <span class="kn">import</span> <span class="n">Order</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">is_order</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Order</span><span class="p">):</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="n">value</span>
<span class="gp">... </span>    <span class="k">else</span><span class="p">:</span>
<span class="gp">... </span>        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">value</span><span class="si">!r}</span><span class="s2"> is not valid order&quot;</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="nd">@dataclass</span>
<span class="gp">... </span><span class="k">class</span> <span class="nc">Purchase</span><span class="p">(</span><span class="n">Story</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">I</span><span class="o">.</span><span class="n">find_order</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">find_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="gp">... </span>        <span class="n">state</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_order</span><span class="p">(</span><span class="n">order_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="n">load_order</span><span class="p">:</span> <span class="n">Callable</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">PurchaseState</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">order</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">is_order</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">purchase</span> <span class="o">=</span> <span class="n">Purchase</span><span class="p">(</span><span class="n">load_order</span><span class="o">=</span><span class="n">load_order</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">state</span> <span class="o">=</span> <span class="n">PurchaseState</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">purchase</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">state</span><span class="o">.</span><span class="n">order</span>
<span class="go">Order(product=Product(name=&#39;Books&#39;), cost=Cost(at=datetime.datetime(1999, 12, 31, 0, 0), amount=7))</span>
</code></pre></div>
</div>
<input id="__tabbed_5_2" name="__tabbed_5" type="radio" /><label for="__tabbed_5_2">async</label><div class="tabbed-content">
<div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Coroutine</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">stories</span> <span class="kn">import</span> <span class="n">Story</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">State</span><span class="p">,</span> <span class="n">Variable</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">aioapp.repositories</span> <span class="kn">import</span> <span class="n">load_order</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">aioapp.entities</span> <span class="kn">import</span> <span class="n">Order</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">is_order</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Order</span><span class="p">):</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="n">value</span>
<span class="gp">... </span>    <span class="k">else</span><span class="p">:</span>
<span class="gp">... </span>        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="si">!r}</span><span class="s1"> is not valid order&#39;</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="nd">@dataclass</span>
<span class="gp">... </span><span class="k">class</span> <span class="nc">Purchase</span><span class="p">(</span><span class="n">Story</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">I</span><span class="o">.</span><span class="n">find_order</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">find_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="gp">... </span>        <span class="n">state</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_order</span><span class="p">(</span><span class="n">order_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="n">load_order</span><span class="p">:</span> <span class="n">Coroutine</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">PurchaseState</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">order</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">is_order</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">purchase</span> <span class="o">=</span> <span class="n">Purchase</span><span class="p">(</span><span class="n">load_order</span><span class="o">=</span><span class="n">load_order</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">state</span> <span class="o">=</span> <span class="n">PurchaseState</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">purchase</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">state</span><span class="o">.</span><span class="n">order</span>
<span class="go">Order(product=Product(name=&#39;Books&#39;), cost=Cost(at=datetime.datetime(1999, 12, 31, 0, 0), amount=7))</span>
</code></pre></div>
</div>
</div>
<h3 id="constructor-argument-validates-passed-value">Constructor argument validates passed value<a class="headerlink" href="#constructor-argument-validates-passed-value" title="Permanent link">&para;</a></h3>
<p>When pass arguments to the state constructor, validator passed to the <code>Argument</code>
would be applied to the value.</p>
<p>Validator is a function of single argument. It should return argument value or
raise exception if value is wrong.</p>
<p>If validator returns a value, it will be assigned to the state attribute.</p>
<div class="tabbed-set" data-tabs="6:2"><input checked="checked" id="__tabbed_6_1" name="__tabbed_6" type="radio" /><label for="__tabbed_6_1">sync</label><div class="tabbed-content">
<div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">stories</span> <span class="kn">import</span> <span class="n">Story</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">State</span><span class="p">,</span> <span class="n">Argument</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">app.repositories</span> <span class="kn">import</span> <span class="n">load_order</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">app.entities</span> <span class="kn">import</span> <span class="n">Order</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">is_order_id</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="n">value</span>
<span class="gp">... </span>    <span class="k">else</span><span class="p">:</span>
<span class="gp">... </span>        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">value</span><span class="si">!r}</span><span class="s2"> is not valid order id&quot;</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">is_order</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Order</span><span class="p">):</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="n">value</span>
<span class="gp">... </span>    <span class="k">else</span><span class="p">:</span>
<span class="gp">... </span>        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">value</span><span class="si">!r}</span><span class="s2"> is not valid order&quot;</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="nd">@dataclass</span>
<span class="gp">... </span><span class="k">class</span> <span class="nc">Purchase</span><span class="p">(</span><span class="n">Story</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">I</span><span class="o">.</span><span class="n">find_order</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">find_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="gp">... </span>        <span class="n">state</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_order</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">order_id</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="n">load_order</span><span class="p">:</span> <span class="n">Callable</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">PurchaseState</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">order_id</span> <span class="o">=</span> <span class="n">Argument</span><span class="p">(</span><span class="n">is_order_id</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">order</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">is_order</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">purchase</span> <span class="o">=</span> <span class="n">Purchase</span><span class="p">(</span><span class="n">load_order</span><span class="o">=</span><span class="n">load_order</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">state</span> <span class="o">=</span> <span class="n">PurchaseState</span><span class="p">(</span><span class="n">order_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">purchase</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">state</span><span class="o">.</span><span class="n">order_id</span>
<span class="go">1</span>
</code></pre></div>
</div>
<input id="__tabbed_6_2" name="__tabbed_6" type="radio" /><label for="__tabbed_6_2">async</label><div class="tabbed-content">
<div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Coroutine</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">stories</span> <span class="kn">import</span> <span class="n">Story</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">State</span><span class="p">,</span> <span class="n">Argument</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">aioapp.repositories</span> <span class="kn">import</span> <span class="n">load_order</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">aioapp.entities</span> <span class="kn">import</span> <span class="n">Order</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">is_order_id</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="n">value</span>
<span class="gp">... </span>    <span class="k">else</span><span class="p">:</span>
<span class="gp">... </span>        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="si">!r}</span><span class="s1"> is not valid order id&#39;</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">is_order</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Order</span><span class="p">):</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="n">value</span>
<span class="gp">... </span>    <span class="k">else</span><span class="p">:</span>
<span class="gp">... </span>        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="si">!r}</span><span class="s1"> is not valid order&#39;</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="nd">@dataclass</span>
<span class="gp">... </span><span class="k">class</span> <span class="nc">Purchase</span><span class="p">(</span><span class="n">Story</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">I</span><span class="o">.</span><span class="n">find_order</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">find_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="gp">... </span>        <span class="n">state</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_order</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">order_id</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="n">load_order</span><span class="p">:</span> <span class="n">Coroutine</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">PurchaseState</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">order_id</span> <span class="o">=</span> <span class="n">Argument</span><span class="p">(</span><span class="n">is_order_id</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">order</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">is_order</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">purchase</span> <span class="o">=</span> <span class="n">Purchase</span><span class="p">(</span><span class="n">load_order</span><span class="o">=</span><span class="n">load_order</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">state</span> <span class="o">=</span> <span class="n">PurchaseState</span><span class="p">(</span><span class="n">order_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">purchase</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">state</span><span class="o">.</span><span class="n">order_id</span>
<span class="go">1</span>
</code></pre></div>
</div>
</div>
<h3 id="validation-errors-are-propagated-as-usual-errors">Validation errors are propagated as usual errors<a class="headerlink" href="#validation-errors-are-propagated-as-usual-errors" title="Permanent link">&para;</a></h3>
<p>If validation function raises exception, story execution would stops. It would
be propagated as usual exception which could happend inside the step.</p>
<div class="tabbed-set" data-tabs="7:2"><input checked="checked" id="__tabbed_7_1" name="__tabbed_7" type="radio" /><label for="__tabbed_7_1">sync</label><div class="tabbed-content">
<div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">stories</span> <span class="kn">import</span> <span class="n">Story</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">State</span><span class="p">,</span> <span class="n">Variable</span>

<span class="gp">&gt;&gt;&gt; </span><span class="nd">@dataclass</span>
<span class="gp">... </span><span class="k">class</span> <span class="nc">Purchase</span><span class="p">(</span><span class="n">Story</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">I</span><span class="o">.</span><span class="n">find_order</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">find_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="gp">... </span>        <span class="n">state</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_order</span><span class="p">(</span><span class="n">order_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="n">load_order</span><span class="p">:</span> <span class="n">Callable</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">PurchaseState</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">order</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">is_order</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">purchase</span> <span class="o">=</span> <span class="n">Purchase</span><span class="p">(</span><span class="n">load_order</span><span class="o">=</span><span class="k">lambda</span> <span class="n">order_id</span><span class="p">:</span> <span class="kc">None</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">state</span> <span class="o">=</span> <span class="n">PurchaseState</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">purchase</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
  <span class="c">...</span>
<span class="gr">Exception</span>: <span class="n">None is not valid order</span>
</code></pre></div>
</div>
<input id="__tabbed_7_2" name="__tabbed_7" type="radio" /><label for="__tabbed_7_2">async</label><div class="tabbed-content">
<div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Coroutine</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">stories</span> <span class="kn">import</span> <span class="n">Story</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">State</span><span class="p">,</span> <span class="n">Variable</span>

<span class="gp">&gt;&gt;&gt; </span><span class="nd">@dataclass</span>
<span class="gp">... </span><span class="k">class</span> <span class="nc">Purchase</span><span class="p">(</span><span class="n">Story</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">I</span><span class="o">.</span><span class="n">find_order</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">find_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="gp">... </span>        <span class="n">state</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_order</span><span class="p">(</span><span class="n">order_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="n">load_order</span><span class="p">:</span> <span class="n">Coroutine</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">PurchaseState</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">order</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">is_order</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">async</span> <span class="k">def</span> <span class="nf">load_order</span><span class="p">(</span><span class="n">order_id</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">pass</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">purchase</span> <span class="o">=</span> <span class="n">Purchase</span><span class="p">(</span><span class="n">load_order</span><span class="o">=</span><span class="n">load_order</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">state</span> <span class="o">=</span> <span class="n">PurchaseState</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">purchase</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>
<span class="gt">Traceback (most recent call last):</span>
  <span class="c">...</span>
<span class="gr">Exception</span>: <span class="n">None is not valid order</span>
</code></pre></div>
</div>
</div>
<h3 id="validation-errors-would-be-raised-by-constructor">Validation errors would be raised by constructor<a class="headerlink" href="#validation-errors-would-be-raised-by-constructor" title="Permanent link">&para;</a></h3>
<p>If validation funcution raises exception, state constructor would propagate this
error.</p>
<div class="tabbed-set" data-tabs="8:2"><input checked="checked" id="__tabbed_8_1" name="__tabbed_8" type="radio" /><label for="__tabbed_8_1">sync</label><div class="tabbed-content">
<div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">stories</span> <span class="kn">import</span> <span class="n">Story</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">State</span><span class="p">,</span> <span class="n">Argument</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">app.repositories</span> <span class="kn">import</span> <span class="n">load_order</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">is_order_id</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="n">value</span>
<span class="gp">... </span>    <span class="k">else</span><span class="p">:</span>
<span class="gp">... </span>        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">value</span><span class="si">!r}</span><span class="s2"> is not valid order id&quot;</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="nd">@dataclass</span>
<span class="gp">... </span><span class="k">class</span> <span class="nc">Purchase</span><span class="p">(</span><span class="n">Story</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">I</span><span class="o">.</span><span class="n">find_order</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">find_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="gp">... </span>        <span class="n">state</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_order</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">order_id</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="n">load_order</span><span class="p">:</span> <span class="n">Callable</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">PurchaseState</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">order_id</span> <span class="o">=</span> <span class="n">Argument</span><span class="p">(</span><span class="n">is_order_id</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">purchase</span> <span class="o">=</span> <span class="n">Purchase</span><span class="p">(</span><span class="n">load_order</span><span class="o">=</span><span class="n">load_order</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">PurchaseState</span><span class="p">(</span><span class="n">order_id</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
  <span class="c">...</span>
<span class="gr">Exception</span>: <span class="n">&#39;1&#39; is not valid order id</span>
</code></pre></div>
</div>
<input id="__tabbed_8_2" name="__tabbed_8" type="radio" /><label for="__tabbed_8_2">async</label><div class="tabbed-content">
<div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Coroutine</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">stories</span> <span class="kn">import</span> <span class="n">Story</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">State</span><span class="p">,</span> <span class="n">Argument</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">aioapp.repositories</span> <span class="kn">import</span> <span class="n">load_order</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">is_order_id</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="n">value</span>
<span class="gp">... </span>    <span class="k">else</span><span class="p">:</span>
<span class="gp">... </span>        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="si">!r}</span><span class="s1"> is not valid order id&#39;</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="nd">@dataclass</span>
<span class="gp">... </span><span class="k">class</span> <span class="nc">Purchase</span><span class="p">(</span><span class="n">Story</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">I</span><span class="o">.</span><span class="n">find_order</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">find_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="gp">... </span>        <span class="n">state</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_order</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">order_id</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="n">load_order</span><span class="p">:</span> <span class="n">Coroutine</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">PurchaseState</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">order_id</span> <span class="o">=</span> <span class="n">Argument</span><span class="p">(</span><span class="n">is_order_id</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">purchase</span> <span class="o">=</span> <span class="n">Purchase</span><span class="p">(</span><span class="n">load_order</span><span class="o">=</span><span class="n">load_order</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">PurchaseState</span><span class="p">(</span><span class="n">order_id</span><span class="o">=</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
  <span class="c">...</span>
<span class="gr">Exception</span>: <span class="n">&#39;1&#39; is not valid order id</span>
</code></pre></div>
</div>
</div>
<h3 id="validation-could-normalize-value">Validation could normalize value<a class="headerlink" href="#validation-could-normalize-value" title="Permanent link">&para;</a></h3>
<p>Validator function could cast value passed to it to the new type. It's a similar
process to normalization common to API schema libraries. To convert passed value
to something new, just return new thing. New value returned by validator
function would be assigned to the state attribute.</p>
<p>This works both for <code>Variable</code> and <code>Argument</code> validators.</p>
<div class="tabbed-set" data-tabs="9:2"><input checked="checked" id="__tabbed_9_1" name="__tabbed_9" type="radio" /><label for="__tabbed_9_1">sync</label><div class="tabbed-content">
<div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">stories</span> <span class="kn">import</span> <span class="n">Story</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">State</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">app.entities</span> <span class="kn">import</span> <span class="n">Customer</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">is_customer</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">==</span> <span class="p">{</span><span class="s1">&#39;balance&#39;</span><span class="p">}</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="n">Customer</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">])</span>
<span class="gp">... </span>    <span class="k">else</span><span class="p">:</span>
<span class="gp">... </span>        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="si">!r}</span><span class="s1"> is not valid customer&#39;</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="nd">@dataclass</span>
<span class="gp">... </span><span class="k">class</span> <span class="nc">Purchase</span><span class="p">(</span><span class="n">Story</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">I</span><span class="o">.</span><span class="n">find_customer</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">find_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="gp">... </span>        <span class="n">state</span><span class="o">.</span><span class="n">customer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_customer</span><span class="p">(</span><span class="n">customer_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="n">load_customer</span><span class="p">:</span> <span class="n">Callable</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">PurchaseState</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">customer</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">is_customer</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">load_customer</span><span class="p">(</span><span class="n">customer_id</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;balance&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">}</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">purchase</span> <span class="o">=</span> <span class="n">Purchase</span><span class="p">(</span><span class="n">load_customer</span><span class="o">=</span><span class="n">load_customer</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">state</span> <span class="o">=</span> <span class="n">PurchaseState</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">purchase</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">state</span><span class="o">.</span><span class="n">customer</span>
<span class="go">Customer(balance=100)</span>
</code></pre></div>
</div>
<input id="__tabbed_9_2" name="__tabbed_9" type="radio" /><label for="__tabbed_9_2">async</label><div class="tabbed-content">
<div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Coroutine</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">stories</span> <span class="kn">import</span> <span class="n">Story</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">State</span><span class="p">,</span> <span class="n">Variable</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">app.entities</span> <span class="kn">import</span> <span class="n">Customer</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">is_customer</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">==</span> <span class="p">{</span><span class="s1">&#39;balance&#39;</span><span class="p">}</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">],</span> <span class="nb">int</span><span class="p">):</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="n">Customer</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="s1">&#39;balance&#39;</span><span class="p">])</span>
<span class="gp">... </span>    <span class="k">else</span><span class="p">:</span>
<span class="gp">... </span>        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">value</span><span class="si">!r}</span><span class="s1"> is not valid customer&#39;</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="nd">@dataclass</span>
<span class="gp">... </span><span class="k">class</span> <span class="nc">Purchase</span><span class="p">(</span><span class="n">Story</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">I</span><span class="o">.</span><span class="n">find_customer</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">find_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="gp">... </span>        <span class="n">state</span><span class="o">.</span><span class="n">customer</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_customer</span><span class="p">(</span><span class="n">customer_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="n">load_customer</span><span class="p">:</span> <span class="n">Coroutine</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">PurchaseState</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">customer</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">is_customer</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">async</span> <span class="k">def</span> <span class="nf">load_customer</span><span class="p">(</span><span class="n">customer_id</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;balance&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">}</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">purchase</span> <span class="o">=</span> <span class="n">Purchase</span><span class="p">(</span><span class="n">load_customer</span><span class="o">=</span><span class="n">load_customer</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">state</span> <span class="o">=</span> <span class="n">PurchaseState</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">purchase</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">state</span><span class="o">.</span><span class="n">customer</span>
<span class="go">Customer(balance=100)</span>
</code></pre></div>
</div>
</div>
<h3 id="state-union-joins-all-defined-variables">State union joins all defined variables<a class="headerlink" href="#state-union-joins-all-defined-variables" title="Permanent link">&para;</a></h3>
<p>Story composition requires complicated state object which would define variables
necessary for both stories. If you defined separate state classes for both
stories, you could join variables with <code>State</code> union operation.</p>
<p>State union would include all variables defined in separate State classes.</p>
<div class="tabbed-set" data-tabs="10:2"><input checked="checked" id="__tabbed_10_1" name="__tabbed_10" type="radio" /><label for="__tabbed_10_1">sync</label><div class="tabbed-content">
<div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">stories</span> <span class="kn">import</span> <span class="n">Story</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">State</span><span class="p">,</span> <span class="n">Variable</span><span class="p">,</span> <span class="n">Union</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">app.repositories</span> <span class="kn">import</span> <span class="n">load_order</span><span class="p">,</span> <span class="n">load_customer</span><span class="p">,</span> <span class="n">create_payment</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">app.entities</span> <span class="kn">import</span> <span class="n">Order</span><span class="p">,</span> <span class="n">Customer</span><span class="p">,</span> <span class="n">Payment</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">is_order</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Order</span><span class="p">)</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="n">value</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">is_customer</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Customer</span><span class="p">)</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="n">value</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">is_payment</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Payment</span><span class="p">)</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="n">value</span>

<span class="gp">&gt;&gt;&gt; </span><span class="nd">@dataclass</span>
<span class="gp">... </span><span class="k">class</span> <span class="nc">Purchase</span><span class="p">(</span><span class="n">Story</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">I</span><span class="o">.</span><span class="n">find_order</span>
<span class="gp">... </span>    <span class="n">I</span><span class="o">.</span><span class="n">find_customer</span>
<span class="gp">... </span>    <span class="n">I</span><span class="o">.</span><span class="n">pay</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">find_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="gp">... </span>        <span class="n">state</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_order</span><span class="p">(</span><span class="n">order_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">find_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="gp">... </span>        <span class="n">state</span><span class="o">.</span><span class="n">customer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_customer</span><span class="p">(</span><span class="n">customer_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="n">load_order</span><span class="p">:</span> <span class="n">Callable</span>
<span class="gp">... </span>    <span class="n">load_customer</span><span class="p">:</span> <span class="n">Callable</span>
<span class="gp">... </span>    <span class="n">pay</span><span class="p">:</span> <span class="n">Story</span>

<span class="gp">&gt;&gt;&gt; </span><span class="nd">@dataclass</span>
<span class="gp">... </span><span class="k">class</span> <span class="nc">Pay</span><span class="p">(</span><span class="n">Story</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">I</span><span class="o">.</span><span class="n">persist_payment</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">persist_payment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="gp">... </span>        <span class="n">state</span><span class="o">.</span><span class="n">payment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_payment</span><span class="p">(</span>
<span class="gp">... </span>            <span class="n">order_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">customer_id</span><span class="o">=</span><span class="mi">1</span>
<span class="gp">... </span>        <span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="n">create_payment</span><span class="p">:</span> <span class="n">Callable</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">PurchaseState</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">order</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">is_order</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">customer</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">is_customer</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">PayState</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">payment</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">is_payment</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">pay</span> <span class="o">=</span> <span class="n">Pay</span><span class="p">(</span><span class="n">create_payment</span><span class="o">=</span><span class="n">create_payment</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">purchase</span> <span class="o">=</span> <span class="n">Purchase</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">load_order</span><span class="o">=</span><span class="n">load_order</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">load_customer</span><span class="o">=</span><span class="n">load_customer</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">pay</span><span class="o">=</span><span class="n">pay</span><span class="p">,</span>
<span class="gp">... </span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">state_class</span> <span class="o">=</span> <span class="n">Union</span><span class="p">(</span><span class="n">PurchaseState</span><span class="p">,</span> <span class="n">PayState</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">state</span> <span class="o">=</span> <span class="n">state_class</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">purchase</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">state</span><span class="o">.</span><span class="n">payment</span>
<span class="go">Payment(due_date=datetime.datetime(1999, 12, 31, 0, 0))</span>
</code></pre></div>
</div>
<input id="__tabbed_10_2" name="__tabbed_10" type="radio" /><label for="__tabbed_10_2">async</label><div class="tabbed-content">
<div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Coroutine</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">stories</span> <span class="kn">import</span> <span class="n">Story</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">State</span><span class="p">,</span> <span class="n">Variable</span><span class="p">,</span> <span class="n">Union</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">aioapp.repositories</span> <span class="kn">import</span> <span class="n">load_order</span><span class="p">,</span> <span class="n">load_customer</span><span class="p">,</span> <span class="n">create_payment</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">aioapp.entities</span> <span class="kn">import</span> <span class="n">Order</span><span class="p">,</span> <span class="n">Customer</span><span class="p">,</span> <span class="n">Payment</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">is_order</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Order</span><span class="p">)</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="n">value</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">is_customer</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Customer</span><span class="p">)</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="n">value</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">is_payment</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Payment</span><span class="p">)</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="n">value</span>

<span class="gp">&gt;&gt;&gt; </span><span class="nd">@dataclass</span>
<span class="gp">... </span><span class="k">class</span> <span class="nc">Purchase</span><span class="p">(</span><span class="n">Story</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">I</span><span class="o">.</span><span class="n">find_order</span>
<span class="gp">... </span>    <span class="n">I</span><span class="o">.</span><span class="n">find_customer</span>
<span class="gp">... </span>    <span class="n">I</span><span class="o">.</span><span class="n">pay</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">find_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="gp">... </span>        <span class="n">state</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_order</span><span class="p">(</span><span class="n">order_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">find_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="gp">... </span>        <span class="n">state</span><span class="o">.</span><span class="n">customer</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_customer</span><span class="p">(</span><span class="n">customer_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="n">load_order</span><span class="p">:</span> <span class="n">Callable</span>
<span class="gp">... </span>    <span class="n">load_customer</span><span class="p">:</span> <span class="n">Callable</span>
<span class="gp">... </span>    <span class="n">pay</span><span class="p">:</span> <span class="n">Story</span>

<span class="gp">&gt;&gt;&gt; </span><span class="nd">@dataclass</span>
<span class="gp">... </span><span class="k">class</span> <span class="nc">Pay</span><span class="p">(</span><span class="n">Story</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">I</span><span class="o">.</span><span class="n">persist_payment</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">persist_payment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="gp">... </span>        <span class="n">state</span><span class="o">.</span><span class="n">payment</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_payment</span><span class="p">(</span>
<span class="gp">... </span>            <span class="n">order_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">customer_id</span><span class="o">=</span><span class="mi">1</span>
<span class="gp">... </span>        <span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="n">create_payment</span><span class="p">:</span> <span class="n">Callable</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">PurchaseState</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">order</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">is_order</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">customer</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">is_customer</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">PayState</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">payment</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">is_payment</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">pay</span> <span class="o">=</span> <span class="n">Pay</span><span class="p">(</span><span class="n">create_payment</span><span class="o">=</span><span class="n">create_payment</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">purchase</span> <span class="o">=</span> <span class="n">Purchase</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">load_order</span><span class="o">=</span><span class="n">load_order</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">load_customer</span><span class="o">=</span><span class="n">load_customer</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">pay</span><span class="o">=</span><span class="n">pay</span><span class="p">,</span>
<span class="gp">... </span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">state_class</span> <span class="o">=</span> <span class="n">Union</span><span class="p">(</span><span class="n">PurchaseState</span><span class="p">,</span> <span class="n">PayState</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">state</span> <span class="o">=</span> <span class="n">state_class</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">purchase</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">state</span><span class="o">.</span><span class="n">payment</span>
<span class="go">Payment(due_date=datetime.datetime(1999, 12, 31, 0, 0))</span>
</code></pre></div>
</div>
</div>
<h3 id="state-union-joins-all-variable-validators">State union joins all variable validators<a class="headerlink" href="#state-union-joins-all-variable-validators" title="Permanent link">&para;</a></h3>
<p>Sometimes you would define variable with the same name in different state
classes. Usually, these variables would have different validation functions.
Since different stories has different requirements for them. When you create a
composition of these stories, you expect all requirements to the variable would
be satisfied.</p>
<p>State union would call all validators of the variable at the moment of it
assignment. If at least one validator fails, execution of the story stops on
that error.</p>
<div class="tabbed-set" data-tabs="11:2"><input checked="checked" id="__tabbed_11_1" name="__tabbed_11" type="radio" /><label for="__tabbed_11_1">sync</label><div class="tabbed-content">
<div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">stories</span> <span class="kn">import</span> <span class="n">Story</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">State</span><span class="p">,</span> <span class="n">Variable</span><span class="p">,</span> <span class="n">Union</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">app.repositories</span> <span class="kn">import</span> <span class="n">load_order</span><span class="p">,</span> <span class="n">load_customer</span><span class="p">,</span> <span class="n">create_payment</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">app.entities</span> <span class="kn">import</span> <span class="n">Order</span><span class="p">,</span> <span class="n">Customer</span><span class="p">,</span> <span class="n">Payment</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">is_low_price</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">assert</span> <span class="n">order</span><span class="o">.</span><span class="n">cost</span><span class="o">.</span><span class="n">amount</span> <span class="o">&lt;</span> <span class="mi">500</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="n">order</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">is_recent_price</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">assert</span> <span class="n">order</span><span class="o">.</span><span class="n">cost</span><span class="o">.</span><span class="n">at</span> <span class="o">&gt;=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">1999</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="n">order</span>

<span class="gp">&gt;&gt;&gt; </span><span class="nd">@dataclass</span>
<span class="gp">... </span><span class="k">class</span> <span class="nc">Purchase</span><span class="p">(</span><span class="n">Story</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">I</span><span class="o">.</span><span class="n">find_order</span>
<span class="gp">... </span>    <span class="n">I</span><span class="o">.</span><span class="n">find_customer</span>
<span class="gp">... </span>    <span class="n">I</span><span class="o">.</span><span class="n">pay</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">find_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="gp">... </span>        <span class="n">state</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_order</span><span class="p">(</span><span class="n">order_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">find_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="gp">... </span>        <span class="n">state</span><span class="o">.</span><span class="n">customer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_customer</span><span class="p">(</span><span class="n">customer_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="n">load_order</span><span class="p">:</span> <span class="n">Callable</span>
<span class="gp">... </span>    <span class="n">load_customer</span><span class="p">:</span> <span class="n">Callable</span>
<span class="gp">... </span>    <span class="n">pay</span><span class="p">:</span> <span class="n">Story</span>

<span class="gp">&gt;&gt;&gt; </span><span class="nd">@dataclass</span>
<span class="gp">... </span><span class="k">class</span> <span class="nc">Pay</span><span class="p">(</span><span class="n">Story</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">I</span><span class="o">.</span><span class="n">persist_payment</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">persist_payment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="gp">... </span>        <span class="n">state</span><span class="o">.</span><span class="n">payment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_payment</span><span class="p">(</span>
<span class="gp">... </span>            <span class="n">order_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">customer_id</span><span class="o">=</span><span class="mi">1</span>
<span class="gp">... </span>        <span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="n">create_payment</span><span class="p">:</span> <span class="n">Callable</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">PurchaseState</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">order</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">is_low_price</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">customer</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">PayState</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">order</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">is_recent_price</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">payment</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">pay</span> <span class="o">=</span> <span class="n">Pay</span><span class="p">(</span><span class="n">create_payment</span><span class="o">=</span><span class="n">create_payment</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">purchase</span> <span class="o">=</span> <span class="n">Purchase</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">load_order</span><span class="o">=</span><span class="n">load_order</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">load_customer</span><span class="o">=</span><span class="n">load_customer</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">pay</span><span class="o">=</span><span class="n">pay</span><span class="p">,</span>
<span class="gp">... </span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">state_class</span> <span class="o">=</span> <span class="n">Union</span><span class="p">(</span><span class="n">PurchaseState</span><span class="p">,</span> <span class="n">PayState</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">state</span> <span class="o">=</span> <span class="n">state_class</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">purchase</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">state</span><span class="o">.</span><span class="n">order</span><span class="o">.</span><span class="n">cost</span>
<span class="go">Cost(at=datetime.datetime(1999, 12, 31, 0, 0), amount=7)</span>
</code></pre></div>
</div>
<input id="__tabbed_11_2" name="__tabbed_11" type="radio" /><label for="__tabbed_11_2">async</label><div class="tabbed-content">
<div class="highlight"><pre><span></span><code><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">asyncio</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Coroutine</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">stories</span> <span class="kn">import</span> <span class="n">Story</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">State</span><span class="p">,</span> <span class="n">Variable</span><span class="p">,</span> <span class="n">Union</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">aioapp.repositories</span> <span class="kn">import</span> <span class="n">load_order</span><span class="p">,</span> <span class="n">load_customer</span><span class="p">,</span> <span class="n">create_payment</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">aioapp.entities</span> <span class="kn">import</span> <span class="n">Order</span><span class="p">,</span> <span class="n">Customer</span><span class="p">,</span> <span class="n">Payment</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">is_low_price</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">assert</span> <span class="n">order</span><span class="o">.</span><span class="n">cost</span><span class="o">.</span><span class="n">amount</span> <span class="o">&lt;</span> <span class="mi">500</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="n">order</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">is_recent_price</span><span class="p">(</span><span class="n">order</span><span class="p">):</span>
<span class="gp">... </span>    <span class="k">assert</span> <span class="n">order</span><span class="o">.</span><span class="n">cost</span><span class="o">.</span><span class="n">at</span> <span class="o">&gt;=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">1999</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="gp">... </span>    <span class="k">return</span> <span class="n">order</span>

<span class="gp">&gt;&gt;&gt; </span><span class="nd">@dataclass</span>
<span class="gp">... </span><span class="k">class</span> <span class="nc">Purchase</span><span class="p">(</span><span class="n">Story</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">I</span><span class="o">.</span><span class="n">find_order</span>
<span class="gp">... </span>    <span class="n">I</span><span class="o">.</span><span class="n">find_customer</span>
<span class="gp">... </span>    <span class="n">I</span><span class="o">.</span><span class="n">pay</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">find_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="gp">... </span>        <span class="n">state</span><span class="o">.</span><span class="n">order</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_order</span><span class="p">(</span><span class="n">order_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">find_customer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="gp">... </span>        <span class="n">state</span><span class="o">.</span><span class="n">customer</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_customer</span><span class="p">(</span><span class="n">customer_id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="n">load_order</span><span class="p">:</span> <span class="n">Callable</span>
<span class="gp">... </span>    <span class="n">load_customer</span><span class="p">:</span> <span class="n">Callable</span>
<span class="gp">... </span>    <span class="n">pay</span><span class="p">:</span> <span class="n">Story</span>

<span class="gp">&gt;&gt;&gt; </span><span class="nd">@dataclass</span>
<span class="gp">... </span><span class="k">class</span> <span class="nc">Pay</span><span class="p">(</span><span class="n">Story</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">I</span><span class="o">.</span><span class="n">persist_payment</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">async</span> <span class="k">def</span> <span class="nf">persist_payment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
<span class="gp">... </span>        <span class="n">state</span><span class="o">.</span><span class="n">payment</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_payment</span><span class="p">(</span>
<span class="gp">... </span>            <span class="n">order_id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">customer_id</span><span class="o">=</span><span class="mi">1</span>
<span class="gp">... </span>        <span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="n">create_payment</span><span class="p">:</span> <span class="n">Callable</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">PurchaseState</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">order</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">is_low_price</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">customer</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">PayState</span><span class="p">(</span><span class="n">State</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">order</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">is_recent_price</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">payment</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">pay</span> <span class="o">=</span> <span class="n">Pay</span><span class="p">(</span><span class="n">create_payment</span><span class="o">=</span><span class="n">create_payment</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">purchase</span> <span class="o">=</span> <span class="n">Purchase</span><span class="p">(</span>
<span class="gp">... </span>    <span class="n">load_order</span><span class="o">=</span><span class="n">load_order</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">load_customer</span><span class="o">=</span><span class="n">load_customer</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">pay</span><span class="o">=</span><span class="n">pay</span><span class="p">,</span>
<span class="gp">... </span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">state_class</span> <span class="o">=</span> <span class="n">Union</span><span class="p">(</span><span class="n">PurchaseState</span><span class="p">,</span> <span class="n">PayState</span><span class="p">)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">state</span> <span class="o">=</span> <span class="n">state_class</span><span class="p">()</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">purchase</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">state</span><span class="o">.</span><span class="n">order</span><span class="o">.</span><span class="n">cost</span>
<span class="go">Cost(at=datetime.datetime(1999, 12, 31, 0, 0), amount=7)</span>
</code></pre></div>
</div>
</div>
<p align="center">&mdash; ⭐ &mdash;</p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../story/" class="md-footer__link md-footer__link--prev" aria-label="Previous: Story" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Story
            </div>
          </div>
        </a>
      
      
        
        <a href="../actor/" class="md-footer__link md-footer__link--next" aria-label="Next: Actor" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Actor
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.tabs"], "search": "../assets/javascripts/workers/search.5bf1dace.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.078830c0.min.js"></script>
      
        <script src="../javascripts/extra.js"></script>
      
    
  </body>
</html>